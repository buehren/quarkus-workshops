<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Battle Stats</title>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly-additions.min.css">

    <style>
        .page-title {
            font-size: xx-large;
        }

        .progress {
            background-color: firebrick;
        }

        .progress-bar {
            background: dodgerblue;
        }

    </style>

</head>
<body>
<div class="container">
<div class="row">
    <div class="col"><h1 class="page-title">Super Stats</h1></div>
</div>
</div>

<!-- Login Form -->
<div id="firebaseui-auth-container"></div>

<div class="container container-cards-pf" id="protected-content">
    <div class="row row-cards-pf">

        <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
            <!-- Sign-in status / Sign out Button -->
            <div class="card-pf card-pf-view card-pf-view-select">
                <div class="card-pf-body">
                    <div id="sign-in-status"></div>
                    <button id="sign-out">Sign Out</button>
                </div>
            </div>
        </div>


        <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
            <!-- Top winners -->
            <div class="card-pf card-pf-view card-pf-view-select">
                <h2 class="card-pf-title">
                    <i class="fa fa-trophy"></i> Top Winner
                </h2>
                <div class="card-pf-body">
                    <div id="top-winner">

                    </div>
                </div>
            </div>
        </div>

        <div class="col-xs-12 col-sm-8 col-md-6 col-lg-6">
            <!-- Top losers -->
            <div class="card-pf card-pf-view card-pf-view-select">
                <h2 class="card-pf-title">
                    <i class="fa pficon-rebalance"></i> Heroes vs. Villains
                </h2>
                <div class="card-pf-body">
                    <div class="progress-container progress-description-left progress-label-right">
                        <div class="progress-description">
                            Heroes
                        </div>
                        <div class="progress">
                            <div id="balance" class="progress-bar" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="width: 50%;">
                                <span>Villains</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-xs-12 col-sm-8 col-md-6 col-lg-6">
            <!-- Account Details -->
            <div class="card-pf card-pf-view card-pf-view-select">
                <h2 class="card-pf-title">
                    User Account Details
                </h2>
                <div class="card-pf-body">
                    <pre id="account-details"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/js/patternfly.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.11/c3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js"></script>

<script>
    function updateTop(scores) {
        $("#top-winner").children("p").remove();
        JSON.parse(scores).forEach(function(score) {
            $("#top-winner").append($("<p>" + score.name + " [" + score.score + "]</p>"))
        });
    }

    function updateRatio(ratio) {
        var percent = ratio * 100;
        $("#balance").attr("aria-valuenow", ratio * 100).attr("style", "width: " + percent + "%;");
    }

    var websocket_top;
    var websocket_team;

    function connect() {
        var host = window.location.host;

        websocket_top = new WebSocket("wss://" + host + "/stats/winners");  // for running in Google Cloud Run: wss / for running local: ws
        websocket_top.onmessage = function (event) {
            updateTop(event.data);
        };
        websocket_team = new WebSocket("wss://" + host + "/stats/team");  // for running in Google Cloud Run: wss / for running local: ws
        websocket_team.onmessage = function(event) {
            console.log(event.data);
            updateRatio(event.data);
        };
    }

    function disconnect() {
        if (websocket_team) {
            websocket_team.close();
            websocket_team = null;
        }
        if (websocket_top) {
            websocket_top.close();
            websocket_top = null;
        }
    }
</script>

<!--
    Add Firebase SDKs from CDN
    https://firebase.google.com/docs/web/setup#from-the-cdn
-->

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css" />

<!--
    Add configuration for this app as produced by Firebase
    https://console.firebase.google.com/project/my-microservices-playground/overview
-->
<script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
        apiKey: "AIzaSyCj-JknPsnGbm7Ju1C_PgJNC_e-9wfeYXs",
        authDomain: "my-microservices-playground.firebaseapp.com",
        projectId: "my-microservices-playground",
        storageBucket: "my-microservices-playground.appspot.com",
        messagingSenderId: "955718248212",
        appId: "1:955718248212:web:edba00cb0f0b62e9fa8401"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
</script>

<!--
    User Authentication
    https://firebase.google.com/docs/auth/web/firebaseui
-->
<script type="text/javascript">

    auth_config = {
      signInOptions: [
        {
          provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
          //requireDisplayName: false,
          //signInMethod: firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD,
        }
      ],
      callbacks: {
        signInSuccessWithAuthResult: function(authResult, redirectUrl) {
          var user = authResult.user;
          var credential = authResult.credential;
          var isNewUser = authResult.additionalUserInfo.isNewUser;
          var providerId = authResult.additionalUserInfo.providerId;
          var operationType = authResult.operationType;

          // User successfully signed in.
          return false; // false = do not redirect after login
        },
      },
    };

    // Initialize the FirebaseUI Widget using Firebase.
    var auth_ui = new firebaseui.auth.AuthUI(firebase.auth());

    // Is there an email link sign-in?
    //if (auth_ui.isPendingRedirect()) {
    //    auth_ui.start('#firebaseui-auth-container', auth_config);
    //}
</script>

<!--
    Track the User Auth State
    https://github.com/firebase/firebaseui-web/blob/master/README.md
 -->
<script type="text/javascript">
  initApp = function() {
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        var displayName = user.displayName;
        var email = user.email;
        var emailVerified = user.emailVerified;
        var photoURL = user.photoURL;
        var uid = user.uid;
        var phoneNumber = user.phoneNumber;
        var providerData = user.providerData;
        user.getIdToken().then(function(accessToken) {
          document.getElementById('sign-in-status').textContent = 'Signed in';
          document.getElementById('account-details').textContent = JSON.stringify({
            displayName: displayName,
            email: email,
            emailVerified: emailVerified,
            phoneNumber: phoneNumber,
            photoURL: photoURL,
            uid: uid,
            accessToken: accessToken,
            providerData: providerData
          }, null, '  ');
        });

        document.getElementById('sign-out').style.display = '';
        document.getElementById('protected-content').style.display = '';
        connect();
      } else {
        // User is signed out. / No user is signed in.
        document.getElementById('sign-in-status').textContent = 'Signed out';
        document.getElementById('account-details').textContent = 'null';

        updateTop('[]'); // clear displayed list of top winners
        updateRatio(0.5); // reset bar diagram
        disconnect();

        document.getElementById('protected-content').style.display = 'none';
        document.getElementById('sign-out').style.display = 'none';
        auth_ui.start('#firebaseui-auth-container', auth_config);
      }
    }, function(error) {
      console.log(error);
    });

    document.getElementById('sign-out').addEventListener('click', function() {
      firebase.auth().signOut();
    });
  };

  window.addEventListener('load', function() {
    initApp()
  });
</script>


</body>
</html>
