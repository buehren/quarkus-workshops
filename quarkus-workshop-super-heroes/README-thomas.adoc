= Quarkus Super-Heroes Workshop
:toc:
:toclevels: 9

* xref:../../README.adoc#setup[Setup,window=_blank]
and xref:../../README.adoc#start-project-vm[start,window=_blank]
the Quarkus VM

* xref:../../README.adoc#ssh-login[Login to the Quarkus VM,window=_blank] with your SSH client.

(The links reference my `https://github.com/buehren/learn/blob/master/jvm/quarkus/README.adoc[learn.git/jvm/quarkus/README.adoc]`)

=== Additional setup [[vm-additional-setup]]

* Run the following playbook as described in xref:../../README.adoc#run-playbook[Configure the VM with Ansible] but replace the call of `ansible-playbook` with the following:
+
[source%nowrap,bash]
----
# In the Ansible-Controller VM:

DIR=quarkus/quarkus-workshops/quarkus-workshop-super-heroes/ansible && \
mkdir -pv ~/prj/$DIR && \
rsync -prv vagrant@192.168.42.12:~/$DIR/* ~/prj/$DIR/ && \
cd ~/prj/quarkus/ansible && \
ansible-playbook ~/prj/$DIR/provision.yml
----

=== Local build & run (DEV mode, JVM, Native, Docker)

IMPORTANT: STOP `vagrant rsync-auto` while builds are running to avoid deletion of files when changing anything on the host! +
{empty} +
After that restart it to continue syncing changes from the host to the VM.

* In the Quarkus VM:
+
[source%nowrap,bash]
----
cd ~/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/

./run-infrastructure.sh
./build-ui.sh


# This populates the database on start - enable this once when starting with empty database:
#export QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=drop-and-create

# Build and run in Quarkus DEV mode:
./clean-all.sh
./run-dev-all.sh
# - Now visit the displayed URLs (use 192.168.42.12 instead of localhost).
# - You can make changes in the source code, and Quarkus does a hot replace
#   either at once or on the next HTTP request!
# - Try the Dev UI:
#   http://192.168.42.12:8082/q/dev/
#   http://192.168.42.12:8085/q/dev/
./stop-dev-all.sh

export QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=""


# Build and run JARs in JVMs:
./build-jars-all.sh
./run-jars-all.sh
# Now visit the displayed URLs (use 192.168.42.12 instead of localhost)
./stop-jars-all.sh


# Build and run native executables:
./build-native-all.sh
./run-native-all.sh
# Now visit the displayed URLs (use 192.168.42.12 instead of localhost)
./stop-native-all.sh


# Build and run native executables and Docker images:
./build-docker-all.sh
./run-docker-all.sh
# Now visit the displayed URLs (use 192.168.42.12 instead of localhost)
./stop-docker-all.sh

# Alternative:
# To build the Docker images from native executables built before (see above):
./build-docker-all.sh native-nopackage
----

TODO:

mvn quarkus:dev -DdebugHost=0.0.0.0
mvn quarkus:dev -Ddebug=false


./node_modules/.bin/ng build --prod --base-href "." --watch
+ rm/mkdir/cp-Kommandos aus package.sh
+ touch auf die geänderte datei... (liegt vermutlich an SMB-Mount?)


==== Print Kafka messages

----
./kafkacat.sh
----

=== Google Cloud Run (like Knative)

* Guides:
** https://quarkus.io/guides/deploying-to-google-cloud#deploying-to-google-cloud-run[QUARKUS - DEPLOYING TO GOOGLE CLOUD PLATFORM (GCP)]
** https://medium.com/@alexismp/deploying-a-quarkus-app-to-google-cloud-run-c4a8ca3be526[Deploying a Quarkus native app to Cloud Run]
** https://github.com/quad-teams/quarkus-google-cloud-run[Quick Guide: Quarkus on Google Cloud Run] (includes config files and deploy scripts)
** https://github.com/ahmetb/cloud-run-faq[Google Cloud Run FAQ] (community-maintained informal knowledge base)

==== Setup

* Configure the gcloud CLI as described in `roles/gloud-cli/README.adoc` in the Ansible Configuration Project.


===== Kafka in Confluent Cloud

* https://console.cloud.google.com/marketplace/product/endpoints/payg-prod.gcpmarketplace.confluent.cloud?q=Confluent
* https://console.cloud.google.com/apis/api/payg-prod.gcpmarketplace.confluent.cloud/overview
* https://confluent.cloud/

[source%nowrap,bash]
----
curl -L --http1.1 https://cnfl.io/ccloud-cli | sudo sh -s -- -b /usr/local/bin
ccloud login --save
ccloud environment use env-xxxxx
ccloud kafka cluster use xxx-xxxxx
ccloud api-key store --resource xxx-xxxxx
ccloud api-key use XXXXXXXXXXXXXXXX --resource xxx-xxxxx

ccloud kafka topic create fights

# Add 3 lines with 1. bootstrap servers, 2. api key, 3. api secret:
vi ~/.kafka-api-key
----

===== User authentication

https://cloud.google.com/run/docs/tutorials/identity-platform


https://console.cloud.google.com/marketplace/details/google-cloud-platform/customer-identity?project=_

https://console.cloud.google.com/apis/credentials?project=_
Download OAuth 2.0 Client ID "Web client (auto created by Google Service)"

[source%nowrap,bash]
----
gcloud services enable \
    run.googleapis.com \
    secretmanager.googleapis.com \
    cloudbuild.googleapis.com \
    containerregistry.googleapis.com
----

#sql-component.googleapis.com \



???

https://console.developers.google.com/apis/credentials/oauthclient
Create OAuth client ID
Type: Web application
Name: rest-hero
Authorized redirect URIs
http://localhost:8082
http://192.168.42.12.xip.io:8082
Your Client ID + Your Client Secret notieren

Download client_secret.json


TODO: https://firebase.google.com/docs/admin/setup


https://firebase.google.com/docs/auth/admin/verify-id-tokens

TODO: Verify ID tokens using the Firebase Admin SDK
oder: Verify ID tokens using a third-party JWT library
-> wie in JEE Endpoints?
Aus einem JWT Token:
"iss": "https://securetoken.google.com/my-microservices-playground",

mit .well-known/openid-configuration:
https://securetoken.google.com/my-microservices-playground/.well-known/openid-configuration
enthält:
"jwks_uri": "https://www.googleapis.com/service_accounts/v1/jwk/securetoken@system.gserviceaccount.com",
-> Quarkus beschwert sich, dass unter dieser URL kein OIDC Server zu finden ist

https://accounts.google.com/o/oauth2/v2/auth

https://cloud.google.com/identity-platform/docs/use-rest-api
-> https://identitytoolkit.googleapis.com/v1/accounts:signInWithCustomToken?key=[API_KEY] ???
--> https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key=[API_KEY] ???

  <p>The requested URL <code>/v1/accounts:signInWithCustomToken?key=66Eik66EU3WU_rueTSxdbTX4/.well-known/openid-configuration</code> was not found on this server.  <ins>That’s all we know.</ins>



https://firebase.google.com/docs/auth/admin/manage-sessions#detect_id_token_revocation
--> Detect ID Token revocation! (aber zusätzlicher HTTP-Request an Google-Server nötig!)
--> macht quarkus oidc-connect extension das ohnehin? auth-server-url wird angegeben


https://quarkus.io/guides/security
https://quarkus.io/guides/security#openid-connect
https://quarkus.io/guides/security#smallrye-jwt



If the OAuth2 Authentication server provides JWT Bearer Tokens then you should consider using either OpenId Connect or MicroProfile JWT RBAC extensions


https://quarkus.io/guides/security-openid-connect
--> Bearer Token Authorization, auch JWT


https://quarkus.io/guides/security-jwt
--> verify JSON Web Tokens
--> nötig? was wir brauchen, dürfte auch in oidc-connect extension vorhanden sein


https://quarkus.io/guides/context-propagation
--> für Reactive nötig?
<dependency>
<groupId>io.quarkus</groupId>
<artifactId>quarkus-smallrye-context-propagation</artifactId>
</dependency>


https://quarkus.io/guides/security-customization#custom-jax-rs-securitycontext
--> z.B. um angepassten SecurityPrincipal zu liefern (Name etc.)


https://quarkus.io/guides/security-customization#httpauthenticationmechanism-customization
--> evtl. Google's API hier einbinden (falls nötig... Native evtl. wieder lästig)


https://quarkus.io/guides/security-authorization




curl -v -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6ImM0ZWFhZjkxM2VlNWY0MDY0YmE2NjUzN2M0Njk3YzY5OGE3NGYwODIiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vbXktbWljcm9zZXJ2aWNlcy1wbGF5Z3JvdW5kIiwiYXVkIjoibXktbWljcm9zZXJ2aWNlcy1wbGF5Z3JvdW5kIiwiYXV0aF90aW1lIjoxNjE0Njg1MTM2LCJ1c2VyX2lkIjoiSnhYYlhoNExYTU82UDZnZFFkNDhlNTMyTzlKMyIsInN1YiI6Ikp4WGJYaDRMWE1PNlA2Z2RRZDQ4ZTUzMk85SjMiLCJpYXQiOjE2MTQ2ODUxMzYsImV4cCI6MTYxNDY4ODczNiwiZW1haWwiOiJ0aG9tYXMuYnVlaHJlbkBmZXJjaGF1LmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJmaXJlYmFzZSI6eyJpZGVudGl0aWVzIjp7ImVtYWlsIjpbInRob21hcy5idWVocmVuQGZlcmNoYXUuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoicGFzc3dvcmQifX0.BpWrLWn-KsDp7tvtqzSZgf36iyG8n4IAngVSZU-oJlh4BUB6LFHtCDk5vxwFzwMRqOgsryzPZy9eIAeeRUvEpk-715OQIS-mfrOpAIQf4JzWqxXju0dEWluOKpn51RtOdBAXqpG5VDdOWP14GwAA63bxnVmjj0CZwMYEhCfViiqfAWjoL6oRK9yjtenpWHQtu-io_uQYsvbLZbh0cd8LXUUzGnf4kxhKNsXxXxK7PMtZnT8-GR0EENcDz97XwHObZlrBTdSc7jh001Qa9ZfPR4JcOKgZRI6ltph7ozfG3fTjUV96x6qTbefcqjmYoKz3a4F7GRr1KgPhPbMoW3FE5A" http://192.168.42.12:8082/api/fights/randomfighters



Token-Prüfung / Logout? Request klappt auch nach Logout bzw. Deaktivierung eines Users bei Google. Müsste mit Firebase-API gehen - aber geht es auch anders? Kürzere Access Token Lifespan einstellbar??
https://firebase.google.com/docs/auth/admin/manage-sessions#detect_id_token_revocation



Keycloak:

getestet mit
docker run --name keycloak -e KEYCLOAK_USER=admin -e KEYCLOAK_PASSWORD=admin -p 8180:8080 quay.io/keycloak/keycloak:10.0.1


Damit roles im Token auftauchen:

Standardpfad muss realm_access.roles sein (evtl. zwei Mal ändern und wieder zurück-benennen)

go to Client Scopes > roles Mappers > realm roles
toggle on the 'Add to userinfo', and off the 'Add to token' ones
change the 'Token Claim Name' to whatever you want, anything would work
same applies for client roles, 1. becomes Client Scopes > roles Mappers > client roles
NB: Roles have to be but in the 'Assigned' column in 'Scope' tab



TODO: Client muss Re-Login auslösen, wenn Token abgelaufen!!!

TODO: Workaround für WebSocket...? Gibt es das schon fertig?
https://github.com/quarkusio/quarkus/issues/7414
You could use a Servlet Filter for authentication purposes.
https://stackoverflow.com/questions/42644779/how-to-secure-a-websocket-endpoint-in-java-ee


#https://firebase.flutter.dev/docs/auth/usage/#

#https://pub.dev/packages/flutter_auth_ui#
https://pub.dev/packages/firebase_ui
https://pub.dev/packages/firebase_auth_ui
https://pub.dev/packages/faui
https://github.com/kevinjnguyen/flutter-firebase-registration-ui
https://github.com/putraxor/flutter-login-ui

Web:

https://github.com/FirebaseExtended/flutterfire/blob/master/packages/firebase_auth/firebase_auth_web/README.md
https://blog.codemagic.io/flutter-web-firebase-authentication-and-google-sign-in/


Mit eigener UI:

https://medium.com/flutterdevs/google-sign-in-with-flutter-8960580dec96

https://medium.com/firebase-developers/dive-into-firebase-auth-on-flutter-email-and-link-sign-in-e51603eb08f8

https://dev.to/dav4thevid/set-by-set-guild-on-how-authenticate-your-flutter-app-with-firebase-auth-3lb4
https://dev.to/dav4thevid/how-to-add-firebase-email-verification-to-your-flutter-app-4cbi

https://medium.com/flutter-community/flutter-implementing-google-sign-in-71888bca24ed


===== Google Cloud SQL

====== Deploy Google Cloud SQL Resources

IMPORTANT: The Google Cloud SQL instance and VPC connector are associated with costs. Check the <<cloud-cost-report,billing report>>. +
{empty} +
To save costs when not needed, you can <<stop-start-cloud-resources,stop>> the cloud resources. +
{empty} +
When no longer needed: <<delete-cloud-sql-instance>> and <<delete-cloud-project>>

[source%nowrap,bash]
----
cd ~/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/

# Set environment variables: Follow the instructions in case of errors -
# until it complains about a missing database - we will create that in the next step.
source google-cloudrun-env.sh

# Allow access from this project's Google Cloud Run to Google Cloud SQL:
gcloud projects add-iam-policy-binding $GCLOUD_PROJECT_ID \
  --member serviceAccount:$GCLOUD_SERVICEACCOUNT \
  --role roles/cloudsql.client

# Create PostgreSQL database instance:
TODO: Prepare private IP address before this (currently below) and assign it here already:
  --network=default \
  --assign-ip \
# To disable the public IP address of the database instance,
# replace assign-ip with no-assign-ip
# (this disables external/local access with cloud-sql-proxy):
#  --no-assign-ip \
gcloud sql instances create my-database \
  --tier=db-f1-micro \
  --region=$GCLOUD_REGION \
  --assign-ip \
  --database-version=POSTGRES_13 \
  --storage-type=SSD \
  --storage-size=10GB

# Set environment variables again - now it should finish successfully:
source google-cloudrun-env.sh

# Set postgres password:
gcloud sql users set-password postgres --instance=$GCLOUD_DB_INSTANCE --prompt-for-password

# Create users:
gcloud sql users create superman --password=superman --instance=$GCLOUD_DB_INSTANCE
gcloud sql users create superbad --password=superbad --instance=$GCLOUD_DB_INSTANCE
gcloud sql users create superfight --password=superfight --instance=$GCLOUD_DB_INSTANCE

# Create databases in the postgres console:
gcloud sql connect $GCLOUD_DB_INSTANCE

# Run these commands in the postgres console:
GRANT superman TO postgres;
GRANT superbad TO postgres;
GRANT superfight TO postgres;
CREATE DATABASE heroes_database OWNER superman;
CREATE DATABASE villains_database OWNER superbad;
CREATE DATABASE fights_database OWNER superfight;
\l


# Setup private IP address for database instance
# https://cloud.google.com/sql/docs/postgres/connect-run#private-ip
# https://cloud.google.com/sql/docs/postgres/configure-private-ip
# https://cloud.google.com/sql/docs/postgres/configure-private-services-access
# https://cloud.google.com/vpc/docs/configure-serverless-vpc-access#creating_a_connector

gcloud services enable servicenetworking.googleapis.com
gcloud services enable compute.googleapis.com
gcloud services enable vpcaccess.googleapis.com

gcloud compute addresses create google-managed-services-default \
    --global \
    --purpose=VPC_PEERING \
    --addresses=192.168.100.0 \
    --prefix-length=24 \
    --network=default

gcloud services vpc-peerings connect \
    --service=servicenetworking.googleapis.com \
    --ranges=google-managed-services-default \
    --network=default

gcloud beta sql instances patch $GCLOUD_DB_INSTANCE \
  --network=default \
  --assign-ip
# To disable the public IP address of the database instance,
# replace assign-ip with no-assign-ip
# (this disables external/local access with cloud-sql-proxy):
#  --no-assign-ip

./google-cloudrun-vpcconnector-create.sh
----

====== Google Cloud SQL Proxy

Install Google Cloud SQL Proxy for accessing the database from the local host:

** You must specify the Google Cloud SQL Connection Name on the following command line.
It is displayed as `GCLOUD_DB_CONNECTION_NAME` when running `source google-cloudrun-env.sh`.

** Run the following playbook as described in <<run-playbook>> but replace the call of `ansible-playbook`
with the following (and replace ... with the Connection Name)
+
[source%nowrap,bash]
----
# In the Ansible-Controller VM:

cd ~/prj/quarkus/ansible && \
ansible-playbook \
  ~/prj/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/ansible/install-google-cloud-sql-proxy.yml \
  --extra-vars "GCLOUD_DB_CONNECTION_NAME=..."
----

** Start Google Cloud SQL Proxy:
+
[source%nowrap,bash]
----
cd ~/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/

source google-cloudsql-local-env.sh
----

** Connect to Google Cloud SQL instance:
+
[source%nowrap,bash]
----
psql -h localhost -U superman -d heroes_database
----

** Stop Google Cloud SQL proxy:
+
[source%nowrap,bash]
----
sudo service cloud-sql-proxy stop
TODO:
pkill cloud-sql-proxy
?
----


====== Google Cloud SQL database connection options [[google-cloud-sql-options]]

Google Cloud SQL can be connected in different ways:

TCP port at public IP address:: Seems not very secure, but you can define the allowed IP addresses.

TCP port at private IP address:: Requires a Google VPC setup that costs (and cannot be accessed from outside - but Public IP address can be enabled at the same time). +
-> *This option is currently used in this project.*

TCP port of cloud-sql-proxy:: Can be used locally or in Google Cloud Run (if cloud-sql-proxy is started in container).
* cloud-sql-proxy itself must be able to access Google Cloud SQL (needs public IP address or connection to VPC).

Unix Socket of cloud-sql-proxy:: Can be used locally (if cloud-sql-proxy is started) or in Google Cloud Run (without starting cloud-sql-proxy).
* Unfortunately using a Unix socket is not -yet- compatible with the Reactive PostgreSQL client in native executables.
* The "regular" PostgreSQL client can (or must?) use Google's Java library with a dedicated SocketFactory.
** But Google's SocketFactory is not compatible with native executables created by GraalVM out of the box
because the library uses reflection a lot -- which cannot be analyzed statically.
** Therefore, we must use the GraalVM native image tracing agent for dynamic analysis
while running the service in JVM mode.
** This was already done (but the resulting configuration is commented-out as it is currently not used). +
-> In <<native-image-agent>> we will see how that works.

'''

* The `rest-hero` microservice contains configurations for all options (inactive ones are commented-out) in link:super-heroes/rest-hero/src/main/resources/application.properties[src/main/resources/application.properties] and link:super-heroes/rest-hero/pom.xml[pom.xml]

** The options for running in Google Cloud are activated by the Maven and Quarkus profiles `googlecloud`.

====== Populate Google Cloud SQL database from localhost

1. Set environment, start Google Cloud SQL Proxy:
+
[source%nowrap,bash]
----
cd ~/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/

source google-cloudsql-local-env.sh
----

2. Create database tables and insert content from `import.sql` into the Google Cloud SQL Database:
+
[source%nowrap,bash]
----
./prepare-db-all.sh
----

3. Stop Google Cloud SQL proxy:
+
[source%nowrap,bash]
----
sudo service cloud-sql-proxy stop
TODO:
pkill cloud-sql-proxy
?
----


---

`quarkus.hibernate-orm.database.generation=drop-and-create` does not (yet) work with `quarkus-reactive-pg-client`:

[.line-through]#2. (Re-)Create database tables and insert content from `import.sql` into the Google Cloud SQL Database using Quarkus DEV mode.#

IMPORTANT: [.line-through]#The following code starts each service in dev-mode to delete and (re-)create
the tables and insert data into the Google Cloud SQL database.# +
{empty} +
[.line-through]#Press CTRL+C (once) for each service after they have started and finished the inserts.#

[%hardbreaks]
[.line-through]#for service in $SUPERHERO_SERVICES; do

    # Service name used in environment variables (upcase and "_"   instead of "-")
    SERVICE=${service^^}
    SERVICE=${SERVICE//-/_}

    var_datasource_instance_ip=SERVICE_${SERVICE}_DATASOURCE_INSTANCE_IP

    cd $service && \
    ${!var_datasource_connection_name}=127.0.0.1 \
        mvn quarkus:dev \
            -Pgooglecloud \
            -Dquarkus.profile=googlecloud \
            -Dquarkus.hibernate-orm.database.generation=drop-and-create \
            -Ddebug=false
    cd ..
done#

==== Run on localhost with access to Google Cloud SQL database and Kafka in Confluent Cloud [[run-local-with-cloud-db]]

IMPORTANT: STOP `vagrant rsync-auto` while builds are running to avoid deletion of files when changing anything on the host! +
{empty} +
After that restart it to continue syncing changes from the host to the VM.

1. Set environment, start Google Cloud SQL Proxy:
+
[source%nowrap,bash]
----
cd ~/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/

source google-cloudsql-local-env.sh
----

2. Run services with access to Google Cloud SQL Database from localhost:
+
TIP: If the JVM mode works but the native mode produces strange exceptions,
it might help to repeat <<native-image-agent>> -- maybe a new library version
needs to be analyzed dynamically.
+
[source%nowrap,bash]
----
./stop-dev-all.sh
./stop-jars-all.sh
./stop-native-all.sh

./build-ui.sh


# To run in Quarkus DEV mode:

./google-cloudrun-run-dev-local-all.sh
# now try the services
./stop-dev-all.sh


# To build JARs and run in JVMs:

./google-cloudrun-build-jars-all.sh && ./run-jars-all.sh
# now try the services
./stop-jars-all.sh


# To build and run native executables:

./google-cloudrun-build-native-all.sh && ./run-native-all.sh
# now try the services
./stop-native-all.sh
----

3. Stop Google Cloud SQL proxy:
+
[source%nowrap,bash]
----
sudo service cloud-sql-proxy stop
TODO:
pkill cloud-sql-proxy
?
----

==== Build and deploy JARs to Google Cloud Run

IMPORTANT: STOP `vagrant rsync-auto` while builds are running to avoid deletion of files when changing anything on the host! +
{empty} +
After that restart it to continue syncing changes from the host to the VM.

[source%nowrap,bash]
----
cd ~/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/

# To build / deploy only certain microservices,
# run this before the build/deploy scripts
# (with the required services instead of the example):
#export SUPERHERO_SERVICES="event-statistics rest-fight"

# Build native executables for Google Cloud Run / Google Cloud SQL:
# (NOT NECESSARY if your last build was native with the googlecloudsql environment variables set)
./build-ui.sh && ./google-cloudrun-build-jars-all.sh

# Deploy to Google Cloud Run
./google-cloudrun-deploy-all.sh jvm
----

==== Configure external libraries for GraalVM with native image agent [[native-image-agent]]

#TODO#

As described in <<google-cloud-sql-options>> ....


* https://github.com/oracle/graal/blob/master/substratevm/Reflection.md
* https://github.com/oracle/graal/blob/master/substratevm/Resources.md
* https://medium.com/graalvm/introducing-the-tracing-agent-simplifying-graalvm-native-image-configuration-c3b56c486271
* https://www.graalvm.org/reference-manual/native-image/BuildConfiguration/#assisted-configuration-of-native-image-builds
* https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory/issues/217
* https://github.com/quarkusio/quarkus/pull/6634
* https://stackoverflow.com/questions/63091045/invalid-jwt-failed-audience-check-when-using-google-api-services-in-graalvm-n
* https://github.com/Taig/flog/blob/cfeff44/modules/stackdriver-http/src/main/resources/META-INF/native-image/io.taig/flog-stackdriver-http/reflect-config.json
* https://github.com/quarkusio/quarkus-quickstarts/compare/master...norrs:mysql_cloudrun_cloudsql


1. Start all services locally in JVMs as described in <<run-local-with-cloud-db>>.

2. Repeat the following for all services or all services that do not work as native executable
(`rest-hero` is used in this example):

a. Set environment variables for accessing Google Cloud SQL and Kafka in Confluent Cloud:
+
[source%nowrap,bash]
----
cd ~/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/

source ./google-cloudsql-local-env.sh
----

b. Restart one service with the GraalVM native image agent enabled:
+
[source%nowrap,bash]
----
# Define the service to be stopped and started:
export SUPERHERO_SERVICES="rest-hero"

# Stop the service:
./stop-jars-all.sh

# Restart the service with the GraalVM native image agent enabled:
export JAVA_EXTRA_ARGS="-agentlib:native-image-agent=config-merge-dir=/home/vagrant/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/graal-native-image-agent/,config-write-period-secs=30"
./run-jars-all.sh
----

c. Now use all functionality of the current service.

d. Stop the service:
+
[source%nowrap,bash]
----
./stop-jars-all.sh
----

e. Copy the results of the GraalVM native image agent from the VM to your host:
+
[source%nowrap,bash]
----
# On host:
cd C:\.....\quarkus\quarkus-workshops\quarkus-workshop-super-heroes\super-heroes

scp vagrant@192.168.42.12:/home/vagrant/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/graal-native-image-agent/*  ./graal-native-image-agent/
----

f. Copy `reflect-config.json` and `resource-config.json`
`from graal-native-image-agent/` to `rest-hero/src/main/resources/`
(replace `rest-hero` with the current service). +
+
Fix syntax in `resource-config.json` (if still necessary, maybe works with newer GraalVM in Quarkus).
+
- TODO: Use the same directory of configuration files for all services to avoid copying to each service.
- TODO: The following interfaces were added manually - this seems to be a bug/misbehaviour of resteasy: +
org.jboss.resteasy.microprofile.config.*ConfigSource +
https://github.com/quarkusio/quarkus/issues/9086 +
https://github.com/quarkusio/quarkus/issues/5492

g. Run `vagrant rsync` on the host to copy the changes to the VM.

h. Build the current service as *native* executable and test it locally:
- `SUPERHERO_SERVICES` must still contain the current service only.
- Then follow the steps for native executable here: <<run-local-with-cloud-db>>.

i. Repeat these steps for all services (that require an updated GraalVM configuration).

3. To finally clean up and stop all services:
+
[source%nowrap,bash]
----
export SUPERHERO_SERVICES=""
export JAVA_EXTRA_ARGS=""

./stop-jars-all.sh
./stop-native-all.sh

sudo service cloud-sql-proxy stop
TODO:
pkill cloud-sql-proxy
?
----

_(Maybe it would be possible to run all services at the same time with the agent enabled,
but maybe that would damage the files written to the config merge directory)._




==== Build and deploy native executables to Google Cloud Run

IMPORTANT: STOP `vagrant rsync-auto` while builds are running to avoid deletion of files when changing anything on the host! +
{empty} +
After that restart it to continue syncing changes from the host to the VM.

[source%nowrap,bash]
----
cd ~/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/

# To build / deploy only certain microservices,
# run this before the build/deploy scripts
# (with the required services instead of the example):
#export SUPERHERO_SERVICES="event-statistics rest-fight"

# Build UI (required for rest-fight):
./build-ui.sh

# Build native executables and Docker images in Google Cloud Build
# and deploy to Google Cloud Run:
./google-cloudrun-deploy-all.sh native


# Alternative:
# To build the native executables locally
# and only build the Docker images in Google Cloud Build:
./google-cloudrun-build-native-all.sh && ./google-cloudrun-deploy-all.sh native-nopackage
----

==== Send requests

#TODO#

 curltime -i https://rest-hero-vsv4xsncya-ey.a.run.app/api/heroes/random

 wsdump.py ws://localhost:8085/stats/winners


time curl $SERVICE_REST_HERO_URL/api/heroes/random
real    0m2.244s
real    0m0.164s

rest-hero 01 native (powered by Quarkus 1.10.3.Final) started in 1.297s. Listening on: http://0.0.0.0:4242


Log explorer!

time curl $SERVICE_REST_HERO_URL/api/heroes/random
TODO


==== Cost Report [[cloud-cost-report]]

Google Cloud Console: https://console.cloud.google.com/billing/[Billing] -> Select Billing Account -> Reports -> Group by: SKU

==== Stop/Start Google Cloud Resources [[stop-start-cloud-resources]]

To reduce <<cloud-cost-report,costs>> while not using the resources, shut down the most costly resources:
[source%nowrap,bash]
----

./google-cloudrun-vpcconnector-delete.sh && \
./google-cloudsql-stop.sh
----

Restart the resources:
[source%nowrap,bash]
----
./google-cloudsql-start.sh  && \
./google-cloudrun-vpcconnector-create.sh
----

==== Delete Google Cloud SQL Instance [[delete-cloud-sql-instance]]

[source%nowrap,bash]
----
gcloud sql instances delete $GCLOUD_DB_INSTANCE
----

==== Delete Google Cloud Project [[delete-cloud-project]]

Web console


=== Knative on local Kubernetes

TODO
C:\Users\tbuehren\Documents\buehren\playground\cloud\kubernetes\knative\quarkus-in-knative-and-googlecloudrun\README.md
C:\Users\tbuehren\Documents\buehren\playground\cloud\kubernetes\knative\quarkus-in-knative-and-googlecloudrun\src\main\knative\service-native.yaml

playbook-kubernetes-knative-local.yml


== App (Flutter)

=== Setup

TODO

https://flutter.dev/docs/get-started/install[Install Flutter] (it is automatically installed in the <<vm-additional-setup,VM>>)

va
In X-Windows nötig? sudo -u $USER bash


[source%nowrap,bash]
----
cd super-heroes/app_superheroes

# Upgrade Flutter and enable Web target
flutter upgrade
flutter config --enable-web

# Check Flutter requirements
flutter doctor
----


GUI einschalten:
VBoxManage startvm quarkus --type separate
oder VirtualBox: Zeigen
vagrant / vagrant
startx

VirtualBox-Menüs anzeigen / verstecken: HOST+C (Standard: HOST=Right-Ctrl)

GUI abschalten:
VBoxManage startvm quarkus --type headless


port forwarding --> Vagrantfile!
plink -batch -N -L 9100:localhost:9100 -L 9099:localhost:9099 -L 8089:localhost:8089 vagrant@192.168.42.12


emulator -accel-check
emulator -avd my_device

https://developer.android.com/studio/run/emulator-acceleration

flutter emulators --launch my_device

flutter emulators
flutter emulators --create
flutter emulators
flutter emulators --launch flutter_emulator


avdmanager -v list avd
avdmanager -v list target

sdkmanager --list_installed

emulator -avd flutter_emulator


=== Run App in Web Browser and Android Emulator

TODO

[source%nowrap,bash]
----
cd super-heroes/app_superheroes

# Clean project
flutter clean

#
flutter run --no-sound-null-safety -d web-server --web-port 8089 --observatory-port 9099 --web-hostname 0.0.0.0
http://127.0.0.1:8089/
http://192.168.42.12:8089/
DEBUG PORT??
http://192.168.42.12:9099/AUTH_CODE=/
?? start chrome --remote-debugging-port=9222



# Run the following run commands in X-Windows or set DISPLAY variable, e.g.
# export DISPLAY=:0

# Build and run/debug app in Web browser
flutter build web
flutter run --no-sound-null-safety -d chrome

# Build and run/debug app in Android Emulator
flutter build apk
# Start Emulator in Android Studio -> Android Virtual Device Manager
flutter devices
flutter run --no-sound-null-safety --observatory-port 9099 -d emulator-5554 # use listed device name

# TODO: Build iOS App
flutter build ipa # MacOS only
----

h = help (z.B. hot reload r, hot restart R, umschalten zwischen iOS und Android mit o, Devtools mit v, )

IntelliJ Dart Remote Debug
9099

=== Run/Debug App on attached Android Device

TODO

* Enable Developer options and USB debugging on your device. Detailed instructions are available in the https://developer.android.com/studio/debug/dev-options.html[Android documentation].
* Using a USB cable, plug your phone into your computer. If prompted on your device, authorize your computer to access your device.

You must install the Extension Pack in order to get USB2(EHCI) and USB3(xHCI) functionality.

That's the Extension Pack - installed on the host. Not the Guest Additions.

Als Administrator

From the File menu, select Preferences. In the window that displays, go to the Extensions category. This shows you the extensions which are currently installed, and enables you to remove a package or add a new package.


https://developer.android.com/studio/command-line/adb

* TODO: VirtualBox: in USB-Einstellungen USB 3.0 aktivieren und Smartphone anklicken, um es mit der VM zu verbinden

VBoxManage list usbhost
VBoxManage controlvm quarkus usbdetach <UUID>
VBoxManage controlvm quarkus usbattach <UUID>


Auf "Dateien übertragen" umschalten

adb devices


lsusb
usb-devices

adb kill-server
adb start-server


Gerät kann nicht auf den Host zugreifen
adb -s UBV7N18A24001184 reverse tcp:8085 tcp:8085
adb -s 192.168.1.76:5555 reverse tcp:8085 tcp:8085
Und in der App localhost:8085 in URLs verwenden


Verbindung per WLAN

Hat nicht geklappt (noch nicht weiter untersucht, evtl. auch nicht nötig)

IP-Adresse ermitteln
adb -s UBV7N18A24001184 shell ip route
TCP/IP-Verbindung auf dem Device aktivieren (muss an USB angeschlossen sein):
adb -s UBV7N18A24001184 tcpip 5555
Jetzt das USB-Kabel trennen.
Dann über das Netzwerk verbinden:
adb connect 192.168.1.76



In X-Windows nötig? sudo -u $USER bash


[source%nowrap,bash]
----
flutter devices                  # connected Android device should be listed
flutter run --no-sound-null-safety --observatory-port 9099 -d UBV7N18A12345678  # use listed device name

flutter run --no-sound-null-safety --observatory-port 9099 -d 192.168.1.76:5555

----

h = help (z.B. umschalten zwischen iOS und Android mit o)



Flutter DevTools, a Flutter debugger and profiler, on EML L29 is available at: http://127.0.0.1:9100?uri=http%3A%2F%2F127.0.0.1%3A9099%2FWZp1efqqrTA%3D%2F


plink -L 9100:localhost:9100 vagrant@192.168.42.12


An Observatory debugger and profiler on EML L29 is available at: http://127.0.0.1:9099/WZp1efqqrTA=/

plink -L 9099:localhost:9099 vagrant@192.168.42.12


== Backlog


done: App


TODO: Probleme im Shared Folder mit Schreibrechten insb. im UI-Verzeichnis (w-Recht fehlt hier bei es5, außerdem fehlt index.html!)

An unhandled exception occurred: EACCES: permission denied, open '/home/vagrant/quarkus/quarkus-workshops/quarkus-workshop-super-heroes/super-heroes/ui-super-heroes/dist/super-heroes/runtime-es5.edb2fcf2778e7bf1d426.js'
See "/tmp/ng-4EPGDQ/angular-errors.log" for further details.

> ll dist/super-heroes/
total 556K
-rwxr-xr-x 1 vagrant vagrant  18K Mar  2 20:49 3rdpartylicenses.txt*
-rwxr-xr-x 1 vagrant vagrant  948 Mar  2 20:49 favicon.ico*
-rwxr-xr-x 1 vagrant vagrant 423K Mar  2 20:49 main-es2015.c1c6435c43f67c3e1dc1.js*
-rwxr-xr-x 1 vagrant vagrant  37K Mar  2 20:49 polyfills-es2015.2987770fde9daa1d8a2e.js*
-r-xr-xr-x 1 vagrant vagrant    0 Mar  2 20:49 polyfills-es5.6696c533341b95a3d617.js*
-rwxr-xr-x 1 vagrant vagrant 1.5K Mar  2 20:49 runtime-es2015.edb2fcf2778e7bf1d426.js*
-r-xr-xr-x 1 vagrant vagrant    0 Mar  2 20:49 runtime-es5.edb2fcf2778e7bf1d426.js*
-rwxr-xr-x 1 vagrant vagrant  64K Mar  2 20:49 styles.91f6f4cafe63146bcc58.css*


TODO: User Auth (OpenID Connect?)

TODO: OIDC: Sign out bzw. kürzere Token-Gültigkeit bzw. Online-Prüfung des Tokens in regelmäßigen Abständen?

TODO: Vagrantfile ins Projekt + Port Forwarding einrichten + neue Optionen konfigurierbar und in Basis + Repository für konfigurierbares Vagrantfile als git submodule?

TODO: Ansible-Repo als Submodule + Deployment ohne Ansible Controller VM?

TODO: Repositories in Ferchau-GitLab einrichten

TODO: Problem mit Instant in SuperStats.java + Fight.java, FightService.java

TODO: Problem mit int in Hero.java

TODO: `super-heroes/ui-super-heroes/src/main/resources/META-INF/resources` oder `.../super-heroes`?? Wg. geänderten copy-Befehl in einem Script? (package.sh?)

TODO: Überall 192.168.42.12.xip.io etc. benutzen wg. User Auth (und in Anleitung: bei Google freischalten)


TODO: Abgeschickte Messages aus Flutter werden lokal geloggt, aber in Cloud Run nicht. +

* Der WebsocketChannel wird direkt nach dem Abschicken geschlossen! Warum?
* Debug-Logs einschalten in Java und in Flutter!
* Blockiert Google etwas? Wo kann man Logs dazu sehen?
* Werden sie nicht abgeschickt? Doch, lokal klappt es
* Kommen sie nicht an? Doch, andere Clients funkionieren aber
* Funktioniert das Logging nicht? Doch, Nachrichten aus wsdump werden aber geloggt
* Funktioniert es nicht mit native executable? Doch, lokal funktioniert auch das

done: USB unzuverlässig? Über WLAN versuchen? -> USB 3 scheint OK

done: HTTP-Verbindung vom Android-Device zu Services auf Localhost wie? Chrome Devices oder SSH-Tunnel manuell?

done: ld hat Probleme mit NFS... Bei native build sporadisch

* `:share_current_dir_nfs_mount_options => %w{rw,async,fsc,nolock,rsize=32768,wsize=32768,hard,noatime,actimeo=2},` +
Probleme:
** ld meldet IO-Fehler
** irgendwann hängen Zugriffe auf gemountetes Verzeichnis
* cachefilesd hat nicht geholfen
* `:share_current_dir_nfs_mount_options => %w{rw,sync,noac,nolock,hard},` +
** extrem langsam beim build (fast 2 stunden für ./build-native-all.sh && ./run-native-all.sh)
** build hat funktioniert (nur 1x probiert), aber danach hing wieder der Zugriff auf das Verzeichnis


TODO: Recherche: Flutter in Apple App Store unproblematisch?

TODO: Flutter iOS und Android in einer App wie?

TODO: App an Cloud Events / Kafka anbinden:
    1. Daten je nach Kunde!
    2. ohne eigenes Websocket?

done: Funktioniert Flutter in VM mit Android-Handy an USB + Emulator? Dann per Ansible in VM installieren.
----
> flutter run -d chrome --release --web-hostname localhost --web-port 7357
No devices found with name or id matching 'chrome'

> export CHROME_EXECUTABLE=/tmp/chrome

> cat /tmp/chrome
echo $* >> /tmp/chrome-parameters.txt

> flutter run -d chrome
Launching lib/main.dart on Chrome in debug mode...
Waiting for connection from debug service on Chrome...

> cat /tmp/chrome-parameters.txt
--version
--user-data-dir=/tmp/flutter_tools.SRWVED/flutter_tools_chrome_device.WUFKUW --remote-debugging-port=43043 --disable-background-timer-throttling --disable-extensions --disable-popup-blocking --bwsi --no-first-run --no-default-browser-check --disable-default-apps --disable-translate http://localhost:34965
----

* TODO: Emulator crasht. Noch mal mit neuester KVM-Version probieren
----
(auch schon alt, evtl. selbst compilieren) https://launchpad.net/~jacob/+archive/ubuntu/virtualisation?field.series_filter=bionic

https://mathiashueber.com/manually-update-qemu-on-ubuntu-18-04/

Ubuntu-Update?

https://wiki.qemu.org/ChangeLog
https://www.linux-kvm.org/page/ChangeLog

#https://wiki.ubuntuusers.de/KVM/# +
https://help.ubuntu.com/community/KVM/Installation

https://galaxy.ansible.com/mrlesmithjr/kvm


egrep -c '(vmx|svm)' /proc/cpuinfo
muss größer 0 sein

kvm-ok

sudo apt update
sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils

kvm --version
/usr/bin/qemu-system-x86_64 --version

sudo adduser ‘username’ libvirt

lsmod | grep kvm

virsh list --all

sudo systemctl status libvirtd
sudo systemctl enable --now libvirtd

> kvm
qemu-system-x86_64: warning: host doesn't support requested feature: CPUID.80000001H:ECX.svm [bit 2]
Could not initialize SDL(No available video device) - exiting

vagrant@quarkus:~/
> kvm --version
QEMU emulator version 2.11.1(Debian 1:2.11+dfsg-1ubuntu7.36)
Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers
----



TODO: Tests ausführen lassen (auch nativ)

done: (Native) Build in Cloud. PC nicht blockiert + Relevant für Gitops

* cloud build auch für native executable verwenden mit two-stage Dockerfile, das es irgendwo gibt
* hier: https://quarkus.io/guides/building-native-image#using-a-multi-stage-docker-build


TODO: Trigger für Cloud-Build einrichten bei Commit/Push

TODO: (Native) Build in Cloud parallelisieren (oder erledigt durch Trigger?)

TODO: Contract Tests zB mit Pact

TODO: https://cloud.google.com/run/docs/authenticating/service-to-service

TODO: iOS-App bauen



done: Profil für Google Cloud Run-Konfiguration

done: Kafka

done: Scripte + Anleitung für JVM Build + Deploy auf Google Cloud Run

done: Native GraalVM configuration für rest-fight und event-statistics

done: Script für ausführung mit agentlib für Graal-Agent!

done: umstellung auf quarkus 1.11, Dev UI?

done: umstellung auf RESTEasy Reactive

done: umstellung auf PostgreSQL Reactive

TODO: (when supported by Vertx/Quarkus) PostgreSQL connection over Unix Socket in native executable (instead of private IP address of DB instance)

* https://github.com/quarkusio/quarkus/issues/12460
* https://stackoverflow.com/questions/62656445/quarkus-datasource-using-unix-socket-is-ignored

[source%nowrap]
----
DEBUG [io.qu.ve.co.ru.VertxCoreRecorder] (main) Vertx has Native Transport Enabled: false

@cescoffier and I have been looking into this. We've reproduced the issue in this small example. For epoll native transport to work in native image, it'd seem that we need to pre-register some classes/field/methdos for JNI access, plus we also need #Netty's AbstractReferenceCounted to be initialized at build time#. We haven't fully settled on a solution yet, but the example above shows one way to make it work.
https://github.com/quarkusio/quarkus/issues/10095
https://github.com/galderz/mendrugo/blob/332a8d0257dc75a8c62a560c43a8104bb99a59ea/epoll-jni-buildtime/Makefile
https://github.com/galderz/mendrugo/blob/332a8d0257dc75a8c62a560c43a8104bb99a59ea/epoll-c/Makefile

--initialize-at-run-time=$(runtime) \

runtime=io.netty.channel.epoll.Epoll,$\
io.netty.channel.epoll.EpollEventArray,$\
io.netty.channel.epoll.EpollEventLoop,$\
io.netty.channel.epoll.Native,$\
io.netty.channel.unix.Errors,$\
io.netty.channel.unix.IovArray,$\
io.netty.channel.unix.Limits,$\
io.netty.channel.unix.Socket

io.netty.channel.epoll.Epoll
     Epoll.isAvailable();
     Epoll.unavailabilityCause();
----

TODO: simplify HeroResource.getHero() + the same for Fight and Villain (how to return "no content" header with Uni?)
TODO: simplify HeroService.updateHero() + the same for Fight and Villain

done: Fix local access to Google Cloud SQL: connection timed out: /192.168.100.3:5432
done: check/fix drop-and-create with reactive postgresql client
TODO: Check DB connection on startup

#TODO: Describe or automate changes for local vs. cloud execution#
----
quarkus-workshop-super-heroes/super-heroes/event-statistics/src/main/resources/META-INF/resources/index.html

    var top = new WebSocket("wss://" + host + "/stats/winners"); // for running in Google Cloud Run: wss // for running in local VM: ws
    var team = new WebSocket("wss://" + host + "/stats/team"); // for running in Google Cloud Run: wss // for running in local VM: ws


quarkus-workshop-super-heroes/super-heroes/ui-super-heroes/src/app/shared/api/fight.service.ts

    protected port = "443"; // for running in Google Cloud Run: "443"; // for running in local VM: "8082";


quarkus-workshop-super-heroes/super-heroes/app_superheroes/lib/main.dart

        webSocketUrl:
          'ws://localhost:8085/stats/winners',
          //'ws://192.168.42.12:8085/stats/winners',
          //'wss://event-statistics-vsv4xsncya-ey.a.run.app/stats/winners',

----


done: startup time google postgresql


TODO: event-statistics web ui websocket reconnect

TODO: Knative Eventing (Cloud Run Eventing) nutzen statt Kafka direkt?

TODO: Secrets (z.B. DB-Passwords, Kafka-Secret) sicher speichern (insb. nicht in variablen in cloud run)

done: Google Cloud SQL über private IP verbinden und firewall-regeln dafür einrichten?
"This guide will help you through the fourth possibility: connecting using service account."  https://github.com/quarkusio/quarkus/pull/6634/files
I don't think this is necessarily a blocker, as Cloud Run now has Serverless VPC access in beta. This means it's possible to connect directly to Cloud SQL via Private IP without the use of this library.

TODO: Knative lokal:

- TODO: workshop-Images als Services installieren
- TODO: PostgreSQL + Kafka
- TODO: Zugriff von anderen Rechnern im Netz
> http http://hello.hello.192.168.1.97.xip.io/ --headers
HTTP/1.1 404 Not Found


TODO: workshop-Images und Infrastruktur automatisieren

TODO: Deploy auf Cloud Run mit yaml + kn / kubetcl statt gcloud-Kommandozeile? Mit .kubeconig? Schon im alten Beispielprojekt? oder im neuen beispielprojekt unter referenzen oben?
gcloud run services replace --platform=managed <file.yaml>
https://github.com/ahmetb/cloud-run-faq#can-i-use-kubectl-to-deploy-to-cloud-run


done: Use Dockerfile.fast-jar and ./mvnw package -Dquarkus.package.type=fast-jar available in later Quarkus versions?

TODO: Oder selbst Container bauen und hochladen: C:\Users\tbuehren\Documents\buehren\playground\cloud\kubernetes\knative\quarkus-in-knative-and-googlecloudrun\README.md


TODO: Dieses Wissen zentral ablegen

done: Reactive API für DB + alles

TODO: Automate Cloud setup with Terraform or something similar (or even Vagrant?)

